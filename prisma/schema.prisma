generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  email                String                @unique
  googleId             String?
  image                String?
  stripeCustomerId     String?
  password             String?
  lastLoginAt          DateTime?
  isDeleted            Boolean?              @default(false)
  isTermsAccepted      Boolean?              @default(false)
  role                 UserRole              @default(USER)
  status               UserStatus            @default(ACTIVE)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  subscriptionPayments SubscriptionPayment[]
  deals                UserDeal[]
  userPackages         UserPackage[]

  @@map("Users")
}

enum UserRole {
  ADMIN
  SUPER_ADMIN
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
}

model SubscriptionPlan {
  id                  String                @id @default(auto()) @map("_id") @db.ObjectId
  name                String                @unique
  stripePriceId       String
  stripeProductId     String
  price               Float
  payoutRange         String
  currency            String                @default("usd")
  interval            BillingCycle          @default(month)
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  features            String[]
  SubscriptionPayment SubscriptionPayment[]
  deals               Deal[]
  userPackages        UserPackage[]

  @@map("SubscriptionPlans")
}

model SubscriptionPayment {
  id                String                    @id @default(auto()) @map("_id") @db.ObjectId
  amount            Float
  paymentMethodId   String
  previousPlanId    String?
  paymentStatus     SubscriptionPaymentStatus @default(PENDING)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  isActive          Boolean                   @default(true)
  cancelAtPeriodEnd Boolean                   @default(false)
  canceledAt        DateTime? // when user canceled
  endDate           DateTime? // when subscription access ends (from Stripe)
  refundedAmount    Float? // for partial refunds
  subscriptionId    String
  userId            String                    @db.ObjectId
  planId            String                    @db.ObjectId
  stripePriceId     String
  stripeProductId   String

  // Relations
  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@map("SubscriptionPayments")
}

enum SubscriptionPaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum BillingCycle {
  month
  year
  week
  day
}


model UserPackage {
  id                   String             @id @default(auto()) @map("_id") @db.ObjectId
  userId               String             @db.ObjectId
  planId               String             @db.ObjectId

  stripeSubscriptionId String?

  status               SubscriptionStatus @default(ACTIVE)

  startDate            DateTime           @default(now())
  nextBillingDate      DateTime?
  paidMonths           Int                @default(0)
  remainingMonths      Int                @default(12)

  activeDeals          Int                @default(0)
  completedDeals       Int                @default(0)
  tokens               Float              @default(0)
  payoutAmount         Float              @default(0)
  payoutDate           DateTime?

  refundStopped        Boolean            @default(false)
  billingStopped       Boolean            @default(false)

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan            SubscriptionPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  refunds         RefundLog[]
  billingLogs     BillingLog[]
  payoutRequests  PayoutRequest[]
  deals           Deal[]
}


model Deal {
  id             String        @id @default(auto()) @map("_id") @db.ObjectId
  userPackageId  String        @db.ObjectId
  planId         String        @db.ObjectId

  activeDeals    Int           @default(0)
  completedDeals Int           @default(0)
  tokens         Float         @default(0)
  payoutAmount   Float         @default(0)
  payoutDate     DateTime?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  userPackage    UserPackage   @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
  plan           SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  users           UserDeal[]

  @@map("Deals")
}

model UserDeal {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  dealId    String   @db.ObjectId
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@unique([userId, dealId])
  @@map("UserDeals")
}


//
// --------------- REFUND LOG (90/180/270/360 days) ---------------
//

model RefundLog {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  userPackageId  String           @db.ObjectId
  milestone      RefundMilestone
  percent        Float
  amount         Float
  createdAt      DateTime         @default(now())

  userPackage    UserPackage      @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
}

//
// --------------- BILLING LOG (Stripe invoices) ---------------
//

model BillingLog {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  userPackageId   String         @db.ObjectId
  stripeInvoiceId String?

  amount          Float
  monthNumber     Int
  status          BillingStatus
  createdAt       DateTime       @default(now())

  userPackage     UserPackage    @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
}

//
// --------------- PAYOUT REQUEST (User withdraws) ---------------
//

model PayoutRequest {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  userPackageId  String      @db.ObjectId

  bankName       String?        // NOT USED for crypto
  accountNumber  String?        // NOT USED for crypto
  walletAddress  String?
  extraInfo      String?

  approved       Boolean      @default(false)
  processedAt    DateTime?
  createdAt      DateTime     @default(now())

  userPackage    UserPackage  @relation(fields: [userPackageId], references: [id], onDelete: Cascade)
}




enum SubscriptionStatus {
  ACTIVE
  COMPLETED
  REMOVED
  PAYOUT_PENDING
  PAYOUT_COMPLETED
}

enum BillingStatus {
  SUCCESS
  FAILED
}

enum RefundMilestone {
  DAY_90
  DAY_180
  DAY_270
  DAY_360
}
